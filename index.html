<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eldritch Dossier - Terminal de Investigación</title>
    
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuración de colores personalizados para Tailwind -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              emerald: {
                950: '#022c22',
              }
            }
          }
        }
      }
    </script>

    <style>
        @keyframes flicker { 
            0% { opacity: 0.05; } 
            50% { opacity: 0.02; } 
            100% { opacity: 0.05; } 
        }
        body { 
            background-color: black; 
            margin: 0;
            overflow-x: hidden;
            color: #10b981;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        /* Personalización de scrollbar estilo terminal */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #064e3b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #10b981; }
        
        .crt-overlay {
            pointer-events: none;
            position: fixed;
            inset: 0;
            z-index: 50;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 4px, 3px 100%;
        }
        
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 51;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, rgba(255, 255, 255, 0.02) 10%, rgba(0, 0, 0, 0.1) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100px; }
        }

        option { background: #000; color: #10b981; }
    </style>
</head>
<body>
    <!-- Efectos visuales fijos -->
    <div class="crt-overlay"></div>
    <div class="scanline"></div>
    <div id="root"></div>

    <!-- Carga de React y dependencias vía ESM -->
    <script type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Search, ShieldAlert, BookOpen, Settings, Info, X, 
            ChevronLeft, ChevronRight, Terminal, Zap, Loader2, 
            AlertCircle, RefreshCw, Database, Globe, Eye, 
            Edit3, Trash2, Plus, Save, ArrowLeft 
        } from 'https://esm.sh/lucide-react';

        // --- CONFIGURACIÓN DE ACCESO PREDETERMINADA ---
        const DEFAULT_TOKEN = "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";
        const DEFAULT_GIST_ID = "e305bff347c21630928b57cadb93ef11";
        const FILENAME = "eldritch_archive_data.json";

        const DangerBadge = ({ level }) => {
          const colors = {
            "Bajo": "text-green-400 border-green-900 bg-green-950/30",
            "Medio": "text-yellow-400 border-yellow-900 bg-yellow-950/30",
            "Alto": "text-orange-500 border-orange-900 bg-orange-950/30",
            "Muy Alto": "text-purple-400 border-purple-900 bg-purple-950/30",
            "Extremo": "text-red-500 border-red-900 bg-red-950/30",
            "Absoluto": "text-red-600 border-red-900 bg-black animate-pulse shadow-[0_0_10px_rgba(220,38,38,0.5)]"
          };
          return (
            <span className={`px-2 py-0.5 rounded border text-[10px] uppercase font-bold tracking-widest ${colors[level] || 'text-gray-400'}`}>
              Nivel: {level}
            </span>
          );
        };

        const GlitchText = ({ children, className = "" }) => {
          return (
            <div className={`relative group inline-block ${className}`}>
              <span className="relative z-10">{children}</span>
              <span className="absolute top-0 left-0 -translate-x-[2px] translate-y-[1px] text-red-500 opacity-0 group-hover:opacity-70 group-hover:animate-pulse z-0">{children}</span>
              <span className="absolute top-0 left-0 translate-x-[2px] -translate-y-[1px] text-cyan-500 opacity-0 group-hover:opacity-70 group-hover:animate-pulse z-0">{children}</span>
            </div>
          );
        };

        function App() {
          const [creatures, setCreatures] = useState([]);
          const [loading, setLoading] = useState(true);
          const [saving, setSaving] = useState(false);
          const [error, setError] = useState(null);
          const [view, setView] = useState('explorer'); 
          const [search, setSearch] = useState("");
          const [selectedCreature, setSelectedCreature] = useState(null);
          const [page, setPage] = useState(1);
          const [retryCount, setRetryCount] = useState(0);
          const [useRaw, setUseRaw] = useState(false); 
          const [isEditing, setIsEditing] = useState(false);
          const [formData, setFormData] = useState({
            id: "", nombre: "", imagen_url: "",
            origen: { cultura: "", mitologia: "", periodo: "" },
            historia: "", descripcion_fisica: "",
            habilidades: [], nivel_peligro: "Bajo", tags: []
          });

          const config = { token: DEFAULT_TOKEN, gistId: DEFAULT_GIST_ID };
          const itemsPerPage = 6;

          const secureRequest = async (url, options = {}) => {
            const defaultHeaders = {
              'Authorization': `Bearer ${config.token}`,
              'Accept': 'application/vnd.github.v3+json',
            };
            const finalOptions = { ...options, mode: 'cors', headers: { ...defaultHeaders, ...options.headers } };
            const response = await fetch(url, finalOptions);
            if (!response.ok) throw new Error(`STATUS_${response.status}`);
            return await response.json();
          };

          const fetchData = async (attempt = 0) => {
            if (attempt === 0) { setLoading(true); setError(null); }
            try {
              let data = null;
              try {
                const rawUrl = `https://gist.githubusercontent.com/raw/${config.gistId}/${FILENAME}?t=${Date.now()}`;
                const rawResponse = await fetch(rawUrl, { mode: 'cors', cache: 'no-store' });
                if (rawResponse.ok) { data = await rawResponse.json(); setUseRaw(true); }
              } catch (e) { console.warn("RAW failed"); }

              if (!data) {
                const gistData = await secureRequest(`https://api.github.com/gists/${config.gistId}`);
                data = JSON.parse(gistData.files[FILENAME].content);
                setUseRaw(false);
              }
              setCreatures(Array.isArray(data) ? data : []);
              setLoading(false);
            } catch (err) {
              if (attempt < 2) {
                setRetryCount(attempt + 1);
                setTimeout(() => fetchData(attempt + 1), 1000);
              } else {
                setError(err.message || "ERROR_ACCESO_DENEGADO");
                setLoading(false);
              }
            }
          };

          useEffect(() => { fetchData(); }, []);

          const syncWithGist = async (newData) => {
            setSaving(true);
            try {
              await secureRequest(`https://api.github.com/gists/${config.gistId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: { [FILENAME]: { content: JSON.stringify(newData, null, 2) } } })
              });
              setCreatures(newData);
              setSaving(false);
              return true;
            } catch (err) {
              alert(`FALLO DE SINCRONIZACIÓN: ${err.message}`);
              setSaving(false);
              return false;
            }
          };

          const handleSave = async (e) => {
            e.preventDefault();
            let updatedList;
            if (isEditing) {
              updatedList = creatures.map(c => c.id === formData.id ? { ...formData, updated_at: new Date().toISOString() } : c);
            } else {
              const newId = `ED-${new Date().toLocaleDateString('es-ES').replace(/\//g, '')}-${(creatures.length + 1).toString().padStart(3, '0')}`;
              updatedList = [...creatures, { ...formData, id: newId, created_at: new Date().toISOString(), status: "active" }];
            }
            if (await syncWithGist(updatedList)) { setView('explorer'); setIsEditing(false); }
          };

          const handleDelete = async (id) => {
            if (!window.confirm("¿CONFIRMA EL BORRADO DEFINITIVO DEL REGISTRO?")) return;
            const updatedList = creatures.filter(c => c.id !== id);
            if (await syncWithGist(updatedList)) { setSelectedCreature(null); }
          };

          const openEditor = (creature = null) => {
            if (creature) { setFormData(creature); setIsEditing(true); }
            else {
              setFormData({
                nombre: "", imagen_url: "", origen: { cultura: "", mitologia: "", periodo: "" },
                historia: "", descripcion_fisica: "", habilidades: [], nivel_peligro: "Bajo", tags: []
              });
              setIsEditing(false);
            }
            setView('editor'); setSelectedCreature(null);
          };

          const filteredCreatures = useMemo(() => {
            return creatures.filter(c => 
              c.status !== "deleted" && (
              c.nombre?.toLowerCase().includes(search.toLowerCase()) || 
              c.id?.toLowerCase().includes(search.toLowerCase()))
            );
          }, [creatures, search]);

          const totalPages = Math.ceil(filteredCreatures.length / itemsPerPage);
          const currentItems = filteredCreatures.slice((page - 1) * itemsPerPage, page * itemsPerPage);

          if (loading) {
            return (
              <div className="min-h-screen bg-black flex flex-col items-center justify-center text-emerald-500 p-4">
                <Loader2 className="w-12 h-12 animate-spin mb-4 text-emerald-800" />
                <div className="text-xl font-black animate-pulse uppercase tracking-[0.3em]">Sincronizando Dossier...</div>
              </div>
            );
          }

          if (error) {
            return (
              <div className="min-h-screen bg-[#0a0000] flex flex-col items-center justify-center text-red-500 p-8 border-4 border-red-900 m-4">
                <AlertCircle className="w-20 h-20 mb-6 animate-bounce" />
                <h2 className="text-3xl font-black uppercase mb-4">FALLO CRÍTICO DE RED</h2>
                <div className="bg-red-950/20 border border-red-900 p-6 mb-8 max-w-xl w-full text-center font-bold italic">{error}</div>
                <button onClick={() => { setError(null); fetchData(); }} className="px-12 py-4 border-2 border-red-600 hover:bg-red-600 hover:text-black transition-all font-black uppercase text-xs tracking-widest">REINICIAR TERMINAL</button>
              </div>
            );
          }

          return (
            <div className="min-h-screen relative overflow-hidden selection:bg-emerald-900 selection:text-white pb-20">
              <header className="relative z-10 pt-10 pb-6 border-b border-emerald-900/40 px-6 bg-black/60 backdrop-blur-md">
                <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-8">
                  <div onClick={() => setView('explorer')} className="cursor-pointer text-center md:text-left">
                    <h1 className="text-4xl md:text-5xl font-black tracking-tighter uppercase italic leading-none">
                      <GlitchText>ELDRITCH DOSSIER</GlitchText>
                    </h1>
                    <p className="text-[9px] text-emerald-800 mt-2 tracking-[0.4em] font-black uppercase">BRIAN_AGUIRRE // SECURED_ENCRYPTION</p>
                  </div>
                  <div className="flex items-center gap-4">
                    <button onClick={() => setView('explorer')} className={`px-4 py-2 border text-[10px] font-bold uppercase transition-all flex items-center gap-2 ${view === 'explorer' ? 'bg-emerald-500 text-black border-emerald-500' : 'border-emerald-900 text-emerald-900 hover:border-emerald-500 hover:text-emerald-500'}`}><Database className="w-3 h-3" /> Explorador</button>
                    <button onClick={() => openEditor()} className={`px-4 py-2 border text-[10px] font-bold uppercase transition-all flex items-center gap-2 ${view === 'editor' ? 'bg-emerald-500 text-black border-emerald-500' : 'border-emerald-900 text-emerald-900 hover:border-emerald-500 hover:text-emerald-500'}`}><Plus className="w-3 h-3" /> Nueva Ficha</button>
                  </div>
                  {view === 'explorer' && (
                    <div className="relative w-full md:w-80 group">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-3 h-3 text-emerald-900 group-focus-within:text-emerald-500" />
                      <input type="text" placeholder="ID O NOMBRE..." className="w-full bg-black border border-emerald-900/50 py-3 pl-10 pr-4 text-xs focus:border-emerald-500 outline-none placeholder:text-emerald-950 uppercase" value={search} onChange={(e) => {setSearch(e.target.value); setPage(1);}} />
                    </div>
                  )}
                </div>
              </header>

              {view === 'explorer' && (
                <main className="relative z-10 max-w-6xl mx-auto p-8 animate-in fade-in duration-500">
                  <div className="flex justify-between items-center mb-10 border-l-2 border-emerald-500 pl-6 py-2 bg-emerald-950/10 uppercase font-bold text-[10px]">
                    <div className="text-emerald-600">Base de datos: {filteredCreatures.length} Sujetos</div>
                    <div className="flex gap-4">
                      {saving && <div className="text-yellow-500 animate-pulse font-black">Transmitiendo...</div>}
                      <button onClick={fetchData} className="text-emerald-900 hover:text-emerald-500 flex items-center gap-2"><RefreshCw className="w-3 h-3" /> Actualizar</button>
                    </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {currentItems.map((creature) => (
                      <div key={creature.id} onClick={() => setSelectedCreature(creature)} className="group cursor-pointer relative bg-black border border-emerald-950 hover:border-emerald-500/40 transition-all p-1 overflow-hidden">
                        <div className="relative h-48 overflow-hidden border border-emerald-950">
                          <img src={creature.imagen_url} className="w-full h-full object-cover grayscale opacity-40 group-hover:grayscale-0 group-hover:opacity-100 group-hover:scale-105 transition-all duration-700" onError={(e) => e.target.src = "https://placehold.co/400x300/000/080?text=CLASIFICADO"} />
                          <div className="absolute top-2 right-2"><DangerBadge level={creature.nivel_peligro} /></div>
                          <div className="absolute bottom-0 left-0 right-0 bg-black/80 p-4 border-t border-emerald-950/50">
                            <div className="text-[8px] text-emerald-900 mb-1 font-black tracking-widest">{creature.id}</div>
                            <h3 className="text-xl font-black text-emerald-500 group-hover:text-white uppercase italic">{creature.nombre}</h3>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  {totalPages > 1 && (
                    <div className="mt-16 flex justify-center items-center gap-8 text-emerald-900 font-black uppercase text-[10px]">
                      <button disabled={page === 1} onClick={() => setPage(p => p - 1)} className="p-2 border border-emerald-950 hover:border-emerald-500 disabled:opacity-20"><ChevronLeft /></button>
                      <div>BLOQUE {page} DE {totalPages}</div>
                      <button disabled={page === totalPages} onClick={() => setPage(p => p + 1)} className="p-2 border border-emerald-950 hover:border-emerald-500 disabled:opacity-20"><ChevronRight /></button>
                    </div>
                  )}
                </main>
              )}

              {view === 'editor' && (
                <main className="relative z-10 max-w-4xl mx-auto p-10 animate-in slide-in-from-bottom-4 duration-500">
                  <div className="flex items-center gap-4 mb-8">
                    <button onClick={() => setView('explorer')} className="p-2 border border-emerald-900 hover:border-emerald-500 text-emerald-900 hover:text-emerald-500"><ArrowLeft /></button>
                    <h2 className="text-3xl font-black uppercase italic">{isEditing ? 'Modificar Registro' : 'Nueva Investigación'}</h2>
                  </div>
                  <form onSubmit={handleSave} className="grid grid-cols-1 md:grid-cols-2 gap-8 bg-black border border-emerald-900/40 p-8 shadow-xl">
                    <div className="space-y-6">
                      <div className="space-y-1"><label className="text-[9px] uppercase font-black text-emerald-900">Identidad</label><input required className="w-full bg-emerald-950/10 border border-emerald-900 p-3 text-xs text-emerald-400 focus:border-emerald-500 outline-none" value={formData.nombre} onChange={e => setFormData({...formData, nombre: e.target.value})} /></div>
                      <div className="space-y-1"><label className="text-[9px] uppercase font-black text-emerald-900">Imagen URL</label><input required className="w-full bg-emerald-950/10 border border-emerald-900 p-3 text-xs text-emerald-400 focus:border-emerald-500 outline-none" value={formData.imagen_url} onChange={e => setFormData({...formData, imagen_url: e.target.value})} /></div>
                      <div className="grid grid-cols-2 gap-4">
                        <input className="w-full bg-emerald-950/10 border border-emerald-900 p-3 text-xs text-emerald-400 outline-none" placeholder="Cultura" value={formData.origen.cultura} onChange={e => setFormData({...formData, origen: {...formData.origen, cultura: e.target.value}})} />
                        <input className="w-full bg-emerald-950/10 border border-emerald-900 p-3 text-xs text-emerald-400 outline-none" placeholder="Mitología" value={formData.origen.mitologia} onChange={e => setFormData({...formData, origen: {...formData.origen, mitologia: e.target.value}})} />
                      </div>
                      <select className="w-full bg-emerald-950/20 border border-emerald-900 p-3 text-xs text-emerald-400 outline-none" value={formData.nivel_peligro} onChange={e => setFormData({...formData, nivel_peligro: e.target.value})}>
                        {["Bajo", "Medio", "Alto", "Muy Alto", "Extremo", "Absoluto"].map(lvl => <option key={lvl} value={lvl}>{lvl}</option>)}
                      </select>
                    </div>
                    <div className="space-y-6">
                      <textarea placeholder="Trasfondo (HTML)" className="w-full h-24 bg-emerald-950/10 border border-emerald-900 p-3 text-xs text-emerald-400 outline-none resize-none" value={formData.historia} onChange={e => setFormData({...formData, historia: e.target.value})} />
                      <textarea placeholder="Morfología (HTML)" className="w-full h-24 bg-emerald-950/10 border border-emerald-900 p-3 text-xs text-emerald-400 outline-none resize-none" value={formData.descripcion_fisica} onChange={e => setFormData({...formData, descripcion_fisica: e.target.value})} />
                      <input className="w-full bg-emerald-950/10 border border-emerald-900 p-3 text-xs text-emerald-400 outline-none" placeholder="Habilidades (Separadas por comas)" value={formData.habilidades.join(", ")} onChange={e => setFormData({...formData, habilidades: e.target.value.split(",").map(i => i.trim())})} />
                    </div>
                    <div className="md:col-span-2 pt-6 border-t border-emerald-900 flex justify-end gap-4 font-black uppercase text-[10px]">
                      <button type="button" onClick={() => setView('explorer')} className="px-8 py-3 text-emerald-900 hover:text-red-500">Abortar</button>
                      <button type="submit" disabled={saving} className="px-10 py-3 bg-emerald-900/20 border border-emerald-500 hover:bg-emerald-500 hover:text-black transition-all flex items-center gap-2">{saving ? <Loader2 className="w-3 h-3 animate-spin" /> : <Save className="w-3 h-3" />} {isEditing ? 'Sincronizar' : 'Registrar'}</button>
                    </div>
                  </form>
                </main>
              )}

              {selectedCreature && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 md:p-8">
                  <div className="absolute inset-0 bg-black/90 backdrop-blur-lg" onClick={() => setSelectedCreature(null)}></div>
                  <div className="relative w-full max-w-5xl bg-[#080808] border border-emerald-500/30 shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh]">
                    <div className="w-full md:w-1/2 relative bg-black">
                      <img src={selectedCreature.imagen_url} className="w-full h-full object-cover grayscale opacity-50" />
                      <div className="absolute bottom-6 left-6 border-l-4 border-red-700 pl-4 bg-black/40 p-4">
                        <div className="text-[10px] text-red-600 font-black uppercase mb-1 tracking-widest">Dossier Aguirre</div>
                        <div className="text-xs text-emerald-500">{selectedCreature.id}</div>
                      </div>
                    </div>
                    <div className="w-full md:w-1/2 p-10 overflow-y-auto bg-black flex flex-col gap-6 scrollbar-thin scrollbar-thumb-emerald-900">
                      <div className="flex justify-between items-start">
                        <div><h2 className="text-4xl font-black italic text-white uppercase mb-2 leading-none">{selectedCreature.nombre}</h2><DangerBadge level={selectedCreature.nivel_peligro} /></div>
                        <button onClick={() => setSelectedCreature(null)} className="p-2 hover:text-red-500"><X className="w-8 h-8" /></button>
                      </div>
                      <div className="grid grid-cols-2 gap-6 border-y border-emerald-900/30 py-4 text-[10px] uppercase font-black">
                        <div><div className="text-emerald-900">Cultura</div><div className="text-emerald-400">{selectedCreature.origen?.cultura || "????"}</div></div>
                        <div><div className="text-emerald-900">Mitología</div><div className="text-emerald-400">{selectedCreature.origen?.mitologia || "????"}</div></div>
                      </div>
                      <div className="space-y-4">
                        <div className="space-y-2 font-black uppercase text-[10px] text-emerald-500 flex items-center gap-2 border-b border-emerald-900 pb-1"><BookOpen className="w-3 h-3" /> Trasfondo</div>
                        <p className="text-xs text-emerald-600 leading-relaxed italic" dangerouslySetInnerHTML={{ __html: selectedCreature.historia || "S/N" }} />
                        <div className="space-y-2 font-black uppercase text-[10px] text-emerald-500 flex items-center gap-2 border-b border-emerald-900 pb-1"><Eye className="w-3 h-3" /> Morfología</div>
                        <p className="text-xs text-emerald-600 leading-relaxed italic" dangerouslySetInnerHTML={{ __html: selectedCreature.descripcion_fisica || "S/N" }} />
                      </div>
                      <div className="flex flex-wrap gap-2 py-4 border-t border-emerald-900/30">
                        {selectedCreature.habilidades?.map(h => <span key={h} className="text-[8px] border border-emerald-900 px-2 py-1 uppercase font-black text-emerald-700 bg-emerald-950/10">{h}</span>)}
                      </div>
                      <div className="mt-auto grid grid-cols-2 gap-4">
                        <button onClick={() => openEditor(selectedCreature)} className="flex items-center justify-center gap-2 py-4 bg-blue-900/10 border border-blue-900 text-[10px] font-black uppercase hover:bg-blue-600 transition-all"><Edit3 className="w-3 h-3" /> Editar</button>
                        <button onClick={() => handleDelete(selectedCreature.id)} className="flex items-center justify-center gap-2 py-4 bg-red-900/10 border border-red-900 text-[10px] font-black uppercase hover:bg-red-600 transition-all"><Trash2 className="w-3 h-3" /> Eliminar</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              <footer className="fixed bottom-0 left-0 right-0 p-4 border-t border-emerald-950 bg-black/80 flex justify-between items-center px-10 text-[9px] font-black text-emerald-950 tracking-[0.3em] uppercase backdrop-blur-md">
                <div>D_SISTEMA_V2.7.5 // BRIAN_AGUIRRE</div>
                <div className="animate-pulse flex items-center gap-3">
                  <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div>
                  DATALINK: {useRaw ? 'OPTIMIZED_RAW' : 'REST_API_STABLE'}
                </div>
              </footer>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
